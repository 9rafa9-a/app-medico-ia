name: Build Flet App

on:
  push:
    branches: [ "main", "master" ]
  workflow_dispatch:

jobs:
  build-android:
    name: Build Android APK
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          path: mobile

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install Python Dependencies
        working-directory: mobile
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.24.3'
          # cache: true (DISABLED)

      - name: Verify Flutter Version
        run: flutter --version

      - name: Accept Android Licenses
        run: |
          yes | flutter doctor --android-licenses || true

      - name: Install Android NDK
        run: |
          echo "y" | $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager "ndk;26.1.10909125"

      - name: Build APK (Force Native Libs & Main Script)
        working-directory: mobile
        run: |
          echo "=== 1. LIMPEZA E PREPARA√á√ÉO ==="
          rm -rf build
          flet build apk --verbose --clear-cache || true
          
          echo "=== 2. LOCALIZANDO PASTAS CR√çTICAS ==="
          SITE_PACKAGES_PATH=$(find $(pwd) -type d -name "site-packages" | head -n 1)
          ANDROID_ROOT=$(find $(pwd) -name "gradlew" -type f | xargs dirname | head -n 1)
          
          if [ -z "$ANDROID_ROOT" ]; then
            echo "‚ùå ERRO: Projeto Android n√£o gerado."
            exit 1
          fi
          
          # === A CORRE√á√ÉO DE OURO: FOR√áAR O MAIN.PY ===
          ASSETS_APP_DIR="$ANDROID_ROOT/app/src/main/assets/app"
          
          echo "=== 3. CIRURGIA NO MAIN.PY ==="
          mkdir -p "$ASSETS_APP_DIR"
          
          if [ -f "main.py" ]; then
             echo "‚úÖ main.py encontrado. Copiando para assets..."
             cp "main.py" "$ASSETS_APP_DIR/main.py"
          else
             echo "‚ùå ERRO CR√çTICO: main.py n√£o encontrado!"
             exit 1
          fi
          
          echo "=== 4. COMPILA√á√ÉO GRADLE ==="
          cd "$ANDROID_ROOT"
          chmod +x gradlew
          export SERIOUS_PYTHON_SITE_PACKAGES="$SITE_PACKAGES_PATH"
          ./gradlew clean assembleRelease --stacktrace
          
          echo "=== 5. RESGATE DO APK (COM PROTE√á√ÉO) ==="
          cd "$GITHUB_WORKSPACE/mobile"
          
          # Encontra o APK gerado
          BUILT_APK=$(find . -name "*.apk" | grep "release" | head -n 1)
          
          if [ -z "$BUILT_APK" ]; then
             echo "‚ùå ERRO: APK sumiu."
             exit 1
          fi
          
          echo "APK ENCONTRADO EM: $BUILT_APK"
          
          # Define destino
          TARGET_DIR="build/apk"
          TARGET_FILE="$TARGET_DIR/app-release.apk"
          mkdir -p "$TARGET_DIR"
          
          # === PROTE√á√ÉO CONTRA O ERRO DE C√ìPIA ===
          ABS_SRC=$(readlink -f "$BUILT_APK")
          ABS_DEST=$(readlink -f "$TARGET_FILE" || echo "$PWD/$TARGET_FILE")
          
          if [ "$ABS_SRC" == "$ABS_DEST" ]; then
            echo "üéâ O arquivo j√° est√° no local correto! Pulando c√≥pia."
          else
            echo "Movendo arquivo para o local de upload..."
            cp "$BUILT_APK" "$TARGET_FILE"
          fi
          
          echo "‚úÖ PROCESSO FINALIZADO COM SUCESSO"

      # ADICIONE ESTE BLOCO AQUI PARA DIAGN√ìSTICO
      - name: Inspect APK Content (Debug)
        working-directory: mobile
        run: |
          sudo apt-get install unzip
          echo "==== CONTE√öDO DA PASTA LIB/ARM64-V8A ===="
          unzip -l build/apk/app-release.apk | grep "lib/arm64-v8a/"
          echo "========================================="

      - name: Upload APK Artifact
        uses: actions/upload-artifact@v4
        with:
          name: android-apk
          path: mobile/build/apk/app-release.apk

  build-windows:
    name: Build Windows EXE
    runs-on: windows-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          path: mobile

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install Python Dependencies
        working-directory: mobile
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.24.3'
          # cache: true (DISABLED)

      - name: Build Windows EXE
        working-directory: mobile
        run: |
          flet build windows --verbose

      # Flet/Flutter builds usually output to build/windows/runner/Release/
      # We upload the whole folder or just the exe and necessary DLLs if needed.
      # For Flet localized builds, it might be simpler to just zip the Release folder.
      - name: Upload Windows Artifact
        uses: actions/upload-artifact@v4
        with:
          name: windows-exe
          path: mobile/build/windows
