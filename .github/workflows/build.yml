name: Build Android APK
on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          path: mobile

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      # === A CORREÇÃO: Flutter 3.22.2 (O Ponto de Equilíbrio) ===
      # Dart 3.4 incluso (compatível com Flet 0.24)
      # Sem as quebras de Gradle do Flutter 3.24
      - name: Setup Flutter 3.22.2
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.22.2'
          channel: 'stable'
          cache: true
      
      - name: Install Dependencies
        working-directory: mobile
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Build APK (Flet 0.24 + Flutter 3.22)
        working-directory: mobile
        run: |
          echo "=== 1. LIMPEZA E PREPARAÇÃO ==="
          rm -rf build
          
          echo "=== 2. BUILD FLET (Usando Flutter 3.22.2) ==="
          # Sem --clear-cache pois não existe na v0.24
          flet build apk --verbose
          
          echo "=== 3. LOCALIZANDO O ANDROID GERADO ==="
          ANDROID_ROOT=$(find $(pwd) -name "gradlew" -type f | xargs dirname | head -n 1)
          
          if [ -z "$ANDROID_ROOT" ]; then
            echo "❌ ERRO: O Flet não gerou a pasta android."
            exit 1
          fi
          
          SITE_PACKAGES_PATH=$(find $(pwd) -type d -name "site-packages" | head -n 1)
          ASSETS_DIR="$ANDROID_ROOT/app/src/main/assets/app"
          
          echo "=== 4. INJEÇÃO DE CÓDIGO (SEGURANÇA PARA 0.24) ==="
          mkdir -p "$ASSETS_DIR"
          
          if [ -f "main.py" ]; then
             echo "✅ Copiando main.py..."
             cp -f "main.py" "$ASSETS_DIR/main.py"
             echo "✅ Criando __init__.py..."
             touch "$ASSETS_DIR/__init__.py"
          else
             echo "❌ ERRO CRÍTICO: main.py não encontrado!"
             exit 1
          fi
          
          echo "=== 5. COMPILAÇÃO GRADLE ==="
          cd "$ANDROID_ROOT"
          chmod +x gradlew
          export SERIOUS_PYTHON_SITE_PACKAGES="$SITE_PACKAGES_PATH"
          ./gradlew clean assembleRelease --stacktrace
          
          echo "=== 6. RESGATANDO O APK ==="
          cd "$GITHUB_WORKSPACE/mobile"
          BUILT_APK=$(find . -name "*.apk" | grep "release" | head -n 1)
          
          TARGET_DIR="build/apk"
          mkdir -p "$TARGET_DIR"
          TARGET_FILE="$TARGET_DIR/app-release.apk"
          
          if [ -f "$BUILT_APK" ]; then
             cp "$BUILT_APK" "$TARGET_FILE"
             echo "✅ APK PRONTO: $TARGET_FILE"
          else
             echo "❌ APK NÃO ENCONTRADO"
             exit 1
          fi

      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: app-release
          path: mobile/build/apk/app-release.apk
