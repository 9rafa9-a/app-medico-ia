name: Build Flet App

on:
  push:
    branches: [ "main", "master" ]
  workflow_dispatch:

jobs:
  build-android:
    name: Build Android APK
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          path: mobile

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install Python Dependencies
        working-directory: mobile
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.24.3'
          # cache: true (DISABLED)

      - name: Verify Flutter Version
        run: flutter --version

      - name: Accept Android Licenses
        run: |
          yes | flutter doctor --android-licenses || true

      - name: Install Android NDK
        run: |
          echo "y" | $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager "ndk;26.1.10909125"

      - name: Build APK (Force Native Libs)
        working-directory: mobile
        run: |
          # 1. Deixa o Flet rodar normal (vai gerar o APK sem a lib, mas cria a estrutura de pastas)
          flet build apk --verbose --clear-cache
          
          # 2. Entra na pasta do projeto Android que o Flet criou
          cd build/apk/android
          
          # 3. Força o Gradle a limpar tudo e recompilar "na marra"
          # Isso obriga o sistema a checar todas as dependências nativas novamente
          chmod +x gradlew
          ./gradlew clean assembleRelease --stacktrace
          
          # 4. Volta para a pasta raiz e pega o NOVO APK gerado pelo Gradle
          cd ../..
          # O Gradle salva o arquivo num caminho profundo, vamos trazê-lo para onde o GitHub espera
          # Ajuste: Copiando para build/apk/app-release.apk para sobrescrever o gerado no passo 1 e ser pego pelo Upload/Debug
          cp build/apk/android/app/build/outputs/apk/release/app-release.apk build/apk/app-release.apk

      # ADICIONE ESTE BLOCO AQUI PARA DIAGNÓSTICO
      - name: Inspect APK Content (Debug)
        working-directory: mobile
        run: |
          sudo apt-get install unzip
          echo "==== CONTEÚDO DA PASTA LIB/ARM64-V8A ===="
          unzip -l build/apk/app-release.apk | grep "lib/arm64-v8a/"
          echo "========================================="

      - name: Upload APK Artifact
        uses: actions/upload-artifact@v4
        with:
          name: android-apk
          path: mobile/build/apk/app-release.apk

  build-windows:
    name: Build Windows EXE
    runs-on: windows-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          path: mobile

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install Python Dependencies
        working-directory: mobile
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.24.3'
          # cache: true (DISABLED)

      - name: Build Windows EXE
        working-directory: mobile
        run: |
          flet build windows --verbose

      # Flet/Flutter builds usually output to build/windows/runner/Release/
      # We upload the whole folder or just the exe and necessary DLLs if needed.
      # For Flet localized builds, it might be simpler to just zip the Release folder.
      - name: Upload Windows Artifact
        uses: actions/upload-artifact@v4
        with:
          name: windows-exe
          path: mobile/build/windows
